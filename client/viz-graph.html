<html>

<head>
    <script type="text/javascript" src="js/d3.min.js"></script>
    <script type="text/javascript" src="js/dagre.min.js"></script>
    <script type="text/javascript" src="js/jquery.min.js"></script>
    <script type="text/javascript" src="js/graphlib.js"></script>
    <script src="js/tipsy.js"></script>

    <link rel="stylesheet" href="css/tipsy.css">
    <link rel="stylesheet" type="text/css" href="css/style.css">
</head>

<body>


    <svg width=800 height=600>
        <g transform="translate(20, 20)" />
    </svg>
    <button id="main">Go back to main.gv</button>
<!--     <button id="zoom">Enable zoom & draging</button> -->



    <script>
        var fileGv = "main.gv";
        var zoom = true;
        draw(fileGv);
        $("#main").click(function() {
            draw("main.gv");
        })
        // $("#zoom").click(function() {
        //     zoom = !zoom;
        //     console.log(zoom);
        //     if(zoom){$("#zoom").html("Disable zoom & draging");}
        //     if(!zoom){$("#zoom").html("Enable zoom & draging");}
        // })

        function draw(fileGv) {

            // States and transitions from RFC 793
            var data, result;
            var xhr = d3.xhr("/gv/"+fileGv, 'text/plain');
            xhr.get(function(err, response) {

                data = response.response;
                result = graphlibDot.parse(data);
                
                var states = Object.keys(result._nodes).map(function(s) {
                    return {
                        id: s,
                        value: {
                            label: s
                        }
                    };
                });
                
                for (var i = 0; i < states.length; i++) {
                    if(states[i].id=="Memory")
                    {
                        if (i > -1) {
                            states.splice(i, 1);
                        }
                    }
                };


                for (var i = 0; i < states.length; i++) {
                    if (result._nodes[states[i].id].value.fillcolor) {

                        states[i].value.style = 'fill:' + result._nodes[states[i].id].value.fillcolor;
                    }
                    if (result._nodes[states[i].id].value.label) {

                        states[i].value.label = result._nodes[states[i].id].value.label;
                    }

                    if (result._nodes[states[i].id].value.URL) {

                        states[i].value.url = result._nodes[states[i].id].value.URL;
                    }
                    if (result._nodes[states[i].id].value.tooltip) {

                        states[i].value.title = result._nodes[states[i].id].value.tooltip;
                    }
                };


                var edges = $.map(result._edges, function(value, index) {
                    return [value];
                });

                // Create a graph from the JSON
                var g = dagreD3.json.decode(states, edges);

                // Create the renderer
                var renderer = new dagreD3.Renderer();

                // Set up an SVG group so that we can translate the final graph.
                var svg = d3.select('svg'),
                    centerG = svg.append('g'),
                    svgGroup = svg.append('g');

                // Set initial zoom to 75%
                var initialScale = 1;
                var oldZoom = renderer.zoom();
                var styleTooltip = function(title) {
                    return "<p>" + title + "</p>";
                };

                var oldDrawNodes = renderer.drawNodes();
                renderer.drawNodes(function(g, svg) {
                    var svgNodes = oldDrawNodes(g, svg);

                    // Set the title on each of the nodes and use tipsy to display the tooltip on hover
                    svgNodes.attr('url', function(d) {
                        return g.node(d).url
                    });
                    svgNodes.attr('title', function(d) {
                            if (g.node(d).title) {
                                return styleTooltip(g.node(d).title)
                            }
                        })
                        .each(function(d) {
                            $(this).tipsy({
                                gravity: 'w',
                                opacity: 1,
                                html: true
                            });
                        });


                    return svgNodes;
                });

                // Run the renderer. This is what draws the final graph.
                var layout = dagreD3.layout()
                    .nodeSep(5)
                    .rankDir("RL");
                renderer.layout(layout).run(g, svg);

                $(".node").click(function() {
                    var url = this.getAttribute("url");
                    if (url) {

                        url = url.split("svg")[0] + "gv";
                        console.log(url);
                        $(".tipsy").remove();
                        draw(url);
                    }
                });



                
                    if(!zoom){
                    svg.call(d3.behavior.zoom().on("zoom", function redraw() {
                        
          
                        svgGroup.attr("transform",
                              "translate(" + d3.event.translate + ")"
                              + " scale(" + d3.event.scale + ")");
                    }));
                    }

                // Center the graph
                // var xCenterOffset = (svg.attr('width') - layout.graph().width * initialScale) / 2;
                // centerG.attr('transform', 'translate(' + xCenterOffset + ', 20)');
                // svg.attr('height', layout.graph().height * initialScale + 60);
            });
        }
    </script>

</body>

</html>